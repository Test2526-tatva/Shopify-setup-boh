<div class='product-modal'>
  <div class='product-modal__header'>
    <div class='product-modal__header--left'>
      {% if feels_like != blank or smells_like != blank %}
        <div class='product-modal__link' data-type='feels-like'>Scent Profile</div>
      {% endif %}
      {% if comparison != blank %}
        <div class='product-modal__link' data-type='comparison'>Comparison</div>
      {% endif %}
      {% if ingredients != blank %}
        <div class='product-modal__link' data-type='ingredients'>Ingredients</div>
      {% endif %}
    </div>
    <div class='product-modal__header--right'>
      <div class='product-modal__close'>
        {% render 'icon-close-modal' %}
      </div>
    </div>
  </div>
  <div class='product-modal__wrap'>
    {% render 'modal-hint' %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    $(document).on('click', '.product-modal__close', function () {
      document.body.classList.remove('product-modal--show');
      $('.product-modal').removeClass(function (index, className) {
        return (className.match(/(^|\s)product-modal--\S+/g) || []).join(' ');
      });
    });

    $(document).on('click', '.product-modal__link', function () {
      let index = $(this).index();
      const type = $(this).data('type');

      $('.product-modal__link').removeClass('active');
      $(this).addClass('active');

      $('.product-modal__content').removeClass('active');
      $('.product-modal__content').eq(index).addClass('active');
    });

    $(document).on('click', '.open-product-modal', function (e) {
      e.preventDefault();
      e.stopPropagation();
      const type = $(this).data('type');
      const handle = $(this).data('product-handle');

      $('body').addClass('product-modal--show');
      window.scrollTo(0, 0);

      $('.product-modal').addClass(`product-modal--${type}`);

      $('.product-modal__link').removeClass('active');
      $(`.product-modal__link[data-type="${type}"]`).addClass('active');

      $('.product-modal__content').removeClass('active');
      $(`.product-modal__content[data-type="${type}"]`).addClass('active');

      if (type === 'info' && handle) {
        const $infoContent = $(`.product-modal__content[data-type="info"]`);

        $infoContent.html('<div class="product-modal__loading">Loading...</div>');

        const url = `/products/${handle}?view=info-modal`;
        fetch(url)
          .then((response) => response.text())
          .then((html) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newInfoContent = doc.querySelector('.product-modal__content[data-type="info"]');

            if (newInfoContent) {
              $infoContent.html(newInfoContent.innerHTML);
            } else {
              $infoContent.html('<p>Error: Could not load product information.</p>');
            }
          })
          .catch((error) => {
            console.error('Error fetching product info:', error);
            $infoContent.html('<p>Error: Could not load product information.</p>');
          });
      }
    });

    $(document).on('click', function (event) {
      if (!$(event.target).closest('.product-modal').length && !$(event.target).is('.open-product-modal')) {
        document.body.classList.remove('product-modal--show');
        $('.product-modal').removeClass(function (index, className) {
          return (className.match(/(^|\s)product-modal--\S+/g) || []).join(' ');
        });
      }
    });

    $(document).on('click', '[data-action="notify"]', function () {
      const emailField = $(this).closest('.product-modal__content').find('input[type="text"]');
      const email = emailField.val();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (emailRegex.test(email)) {
        emailField.removeClass('product-modal__field--error');
        $(this).closest('.product-modal__content').addClass('product-modal__content--success');
        console.log('Notification email:', email);

        $(this).hide();
        $(this).siblings('[data-type="close"]').show();
      } else {
        emailField.addClass('product-modal__field--error');
      }
    });

    $(document).on('click', '[data-type="close"]', function () {
      document.body.classList.remove('product-modal--show');
      $('.product-modal').removeClass(function (index, className) {
        return (className.match(/(^|\s)product-modal--\S+/g) || []).join(' ');
      });
    });
  });
</script>
