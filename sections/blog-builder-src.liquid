{{ 'blog-builder.css' | asset_url | stylesheet_tag }}

{% assign section_id = 'sa-blog-builder--' | append: section.id %}
<section class="sa-blog-builder {{ section_id }}" >

  <div class="sa-blog-builder__modal">
    <div class="sa-blog-builder__modal-box">
      <textarea class="sa-generated-code" rows="5" onclick="this.focus();this.select()" placeholder="Generated code will appear here." readonly="readonly" >{{ generated_code | strip | strip_newlines | escape }}</textarea>

      <div class="sa-blog-builder__modal-actions">
        <a href="javascript:document.querySelector('.{{ section_id }} .sa-blog-builder__modal').classList.remove('active');">
          Close
        </a>
        
        {% comment %} <a href="javascript:document.querySelector('.{{ section_id }} .sa-blog-builder__modal').classList.remove('active');">
          Close
        </a> {% endcomment %}
      </div>
    </div>
  </div>

  <div class="sa-blog-builder__header">
    <h2>
      {{ section.settings.title }}
      <small>Preview</small>
    </h2>

    <div class="article-generator__code">
      {% comment %}  {% endcomment %}

      {% 
        # Using JS Code inside onclick, because the Shopify 
        # would not run the code inside <script></script> tag 
      %}
      <button 
        onclick="(function() {
          const parent = document.querySelector('.{{section_id}}').closest('.sa-blog-builder__section');
          let generatedCode = '';

          let currentSection = parent;
          while( currentSection = currentSection.nextElementSibling ) {
            if( currentSection.classList.contains('sa-blog-builder__section') ) {
              break;
            }

            let html = currentSection.outerHTML;
            generatedCode += html;
          }

          generatedCode = generatedCode
            .replace(/\>[\r\n ]+\</g, '><')
            .replace(/(<.*?>)|\s+/g, (m, $1) => $1 ? $1 : ' ')
            .trim()

          document.querySelector('.{{section_id}} .sa-generated-code').value = generatedCode;
          document.querySelector('.{{section_id}} .sa-blog-builder__modal').classList.add('active');
        })();"
      >
        Generate
      </button>
    </div>
  </div>
</section>


{% schema %}
{
  "name": "Blog Builder",
  "class": "sa-blog-builder__section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Blog Title"
    }
  ]
}
{% endschema %}